name: iOS Build

on:
  push:
    branches:
      - dev  # Trigger on push to the main branch

jobs:
  ios-build:
    name: iOS Build
    runs-on: macos-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v3

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable


      - name: Install dependencies
        run: yarn install --frozen-lockfile --network-timeout 300000

      - name: Build iOS App
        run: |
          cd ios && xcodebuild clean -workspace ci_test.xcworkspace -scheme ci_test -configuration Release -sdk iphoneos

      - name: Export IPA
        run: |
          xcodebuild -exportArchive -archivePath ${{ github.workspace }}/ios/build/ci_test.xcarchive -exportPath ${{ github.workspace }}/ios/build/ -exportOptionsPlist ./ExportOptions.plist

      - name: Upload IPA to Firebase
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID_IOS }}
          token: ${{ secrets.FIREBASE_AUTH_TOKEN }}
          file: ios/build/ci_test.ipa
          groups: "ios"