name: iOS Build

on:
  push:
    branches:
      - dev  # Trigger on push to the main branch

jobs:
  ios-build:
    name: iOS Build
    runs-on: macos-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v3

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable


      - name: Install dependencies
        run: yarn install --frozen-lockfile --network-timeout 300000

# Step 1: Build iOS app
      - name: install Cocoapod dependencies
        run: |
          cd packages/app-mobile/ios
          pod install          

      - name: build archive
        run: |
          cd packages/app-mobile/ios
          xcodebuild -workspace ci_test.xcworkspace \
          -scheme "ci_test" \
          -sdk iphoneos \
          -configuration Debug \
          -destination generic/platform=iOS \
          -archivePath $RUNNER_TEMP/ci_test.xcarchive \
          archive          


      # Step 3: Export IPA
      - name: Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath ${{ github.workspace }}/ios/build/ci_test.xcarchive \
            -exportPath ${{ github.workspace }}/ios/build/ \
            -exportOptionsPlist ${{ github.workspace }}/ios/ExportOptions.plist
                  
      - name: Upload IPA to Firebase
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID_IOS }}
          token: ${{ secrets.FIREBASE_AUTH_TOKEN }}
          file: ios/build/ci_test.ipa
          groups: "ios"